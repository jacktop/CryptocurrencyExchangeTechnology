# Cryptocurrency Exchange Technology

在加密货币交易所工作多年，集齐了大部分该行业的核心技术，年纪大了很容易忘事，特此整理记录，希望可以通过穿插叙事的方式来描述该行业技术的演进。

注意：本文章内容只做技术讨论，不构成任何投资建议。

## 核心技术

中心化加密货币交易所最核心的技术：

- 撮合系统
- 交易系统
- 行情系统 (含kline系统)
- 做市系统 (含对冲)
- MPC钱包系统
- 网络安全基础设施

以上模块除做市系统外，我都集齐了，我将分阶段逐步在此将技术细节开源。

## 撮合与交易系统

撮合与交易系统可以说是这些核心系统中的核心，该系统具有高并发、低延迟、海量数据、公式十分复杂的特点，需要组建一支非常有经验的队友才能真正落地，当时在A公司投入了巨资组建了一个规模空前的团队，大家都寄予厚望，奈何遇上FTX事件导致夭折。

### 最新的架构设计

以下是我设计的最新的系统架构，是参考了H,A,D三家公司的经验和教训而设计。

![](images/撮合与交易系统架构设计.png)

### 服务的整合与拆分

撮合与交易系统是紧密结合的两个系统，可以分开做，也可以做到一起：

- 做到一个服务：在D公司时我是把他们设计在一起
    - 优点：显而易见的最大程序降低了io交互，并且有着强一致性的特点，并且运维简单高效
    - 缺点：当实施分站点，要多个站点使用同一个orderbook时，就很难实现了，在D公司采用了代理下单这种比较绕的方式来解决
- 分开两个服务：在A,H公司则是分开设计，当时在A公司还有深度讨论过是否做到一起，最终分开设计
    - 优点：由于oderbook的独立设计，可以在任意站点、做市商等在同一个book上交易，而资产又是分离的
    - 缺点：交易系统和撮合系统交互非常频繁，又只能是io交互，latency必然变大，同时两个系统之间的数据一致性也需要处理更多的细节，如果程序员经验不足，将会陷入无尽的bug之中，特别是用户资产老是会对不上，当时在A公司的旧系统就是这种情况。

### 分片方案

其实做到一起或者分开，还和分片方案是关联的：

- 做到一个服务：由于orderbook的强顺序匹配，导致撮合系统只能按symbol分片(可多个symbol分为1片)，这导致交易系统也只能和撮合一起，也按symbol分片，我在D公司就是这样做的。
- 分开两个服务：由于服务的拆分，撮合可以按symbol分片，而交易系统的瓶颈是在用户资产的CURD，因此按uid分片更优。

当然如果硬要掰扯，撮合与交易做到一个服务，然后根据symbol分片，按交易对可以分出几百个片，大部分都是量小的，只有BTC,ETH等热门币量大，独立分配一个32核机器给量大的交易对，也是问题不大。

### 内存化处理

而我在D公司的设计其实最大的问题是撮合内存化了但是交易系统的资产没有内存化。如果进一步改造资产内存化实际上将无法实施，这导致单账户单交易对性能瓶颈在数据库行锁的性能，表现就是数据库CPU还没满，但是单用户TPS就压不上去了。如果把资产CURD的io移除，变成内存里面的CURD，TPS将达到极致，因为撮合和交易的整个过程没有io，但设计总是无法完美的，只能取舍。

- 方案1：撮合与交易系统做到同一个服务，只能按symbol分片，下单成交减少了相互操作的io，但是资产无法内存化处理，资产CURD就有io。
- 方案2：撮合与交易系统拆分到两个服务，撮合按symbol分片，交易按uid分片，下单成交避免不了io操作，但是资产可以内存化到分片中。






